<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Интерпретация ЭКГ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
      scroll-behavior: smooth;
    }
    h1, h2, h3 {
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    form, #history, #compareSection, #eosCalcContainer {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 900px;
      margin: 20px auto;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-group, fieldset {
      margin-bottom: 15px;
      position: relative;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }
    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    textarea {
      resize: vertical;
    }
    .horizontal-group {
      display: flex;
      gap: 10px;
    }
    .horizontal-group > div {
      flex: 1;
    }
    .tooltip-container {
      display: inline-block;
      position: relative;
      cursor: pointer;
      color: #007BFF;
      font-weight: bold;
      margin-left: 5px;
    }
    .tooltip-container:hover .tooltip-content {
      display: block;
    }
    .tooltip-content {
      display: none;
      position: absolute;
      top: 20px;
      left: 0;
      z-index: 10;
      width: 250px;
      background-color: #333;
      color: #fff;
      padding: 10px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    button {
      padding: 10px 15px;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 5px;
      margin-right: 10px;
    }
    /* Цветовые классы кнопок */
    .btn-green { background-color: #28a745; }
    .btn-red { background-color: #dc3545; }
    .btn-blue { background-color: #007BFF; }
    .record {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .record:last-child {
      border-bottom: none;
    }
    .record input[type="checkbox"] {
      margin-right: 10px;
    }
    #compareSection {
      display: none;
    }
    table.compare-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table.compare-table th,
    table.compare-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    table.compare-table th {
      background-color: #007BFF;
      color: #fff;
    }
    details {
      transition: max-height 0.3s ease;
      overflow: hidden;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 5px;
      background-color: #f9f9f9;
    }
    details[open] {
      max-height: 1000px;
    }
    details:not([open]) {
      max-height: 30px;
    }
    summary {
      font-weight: bold;
      cursor: pointer;
      padding: 5px;
    }
    /* Стили калькулятора ЭОС */
    #eosCalcContainer {
      margin-top: 20px;
    }
    #eosCalcContainer h3 {
      font-size: 1.2em;
      text-align: left;
      margin-bottom: 10px;
    }
    #eosCalcFields {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    #eosCalcFields > div {
      flex: 1;
    }
    #eosCalcControl {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #eosCalcResult {
      font-size: 1.1em;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Интерпретация ЭКГ</h1>

  <form id="ekgForm">
    <!-- ФИО пациента -->
    <div class="form-group">
      <label for="fio">
        ФИО пациента 
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Введите полное имя пациента.
          </div>
        </span>
      </label>
      <input type="text" id="fio" name="fio" required>
    </div>

    <!-- 1. Оцените вольтаж -->
    <div class="form-group">
      <label for="voltage">
        1. Оцените вольтаж 
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Выберите оценку вольтажа ЭКГ.
          </div>
        </span>
      </label>
      <input type="text" id="voltage" name="voltage" list="voltageList" required>
      <datalist id="voltageList">
        <option value="Нормальный 1мв (10мм)">
        <option value="Не нормальный">
      </datalist>
    </div>

    <!-- 2. Оценка ЧСС & ритма -->
    <fieldset class="form-group">
      <legend>
        2. Оценка ЧСС & ритма 
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Отметьте наличие волн (P, f, F), введите ЧСС, выберите регулярность Р-Р и R-R, а также связь Р с QRS.
          </div>
        </span>
      </legend>
      <div class="form-group">
        <label for="waves">Наличие волн (P, f, F):</label>
        <input type="text" id="waves" name="waves" list="wavesList">
        <datalist id="wavesList">
          <option value="Зубцы-P присутствуют">
          <option value="Волны-f присутствуют">
          <option value="Волны-F присутствуют">
          <option value="P, f, F отсутствуют">
        </datalist>
      </div>
      <div class="form-group">
        <label for="heartRate">ЧСС (уд/мин):</label>
        <input type="number" id="heartRate" name="heartRate" placeholder="Например: 75">
      </div>
      <div class="horizontal-group">
        <div>
          <label for="rrP">Регулярность Р-Р:</label>
          <input type="text" id="rrP" name="rrP" list="rrPList">
          <datalist id="rrPList">
            <option value="Регулярные Р-Р">
            <option value="Нерегулярные Р-Р">
          </datalist>
        </div>
        <div>
          <label for="rrR">Регулярность R-R:</label>
          <input type="text" id="rrR" name="rrR" list="rrRList">
          <datalist id="rrRList">
            <option value="Регулярные R-R">
            <option value="Нерегулярные R-R">
          </datalist>
        </div>
      </div>
      <div class="form-group">
        <label for="pQrsRelation">Связь Р с QRS:</label>
        <input type="text" id="pQrsRelation" name="pQrsRelation" list="pQrsRelationList">
        <datalist id="pQrsRelationList">
          <option value="Каждый зубец P связан c комплексом QRS">
          <option value="Зубец P не связан c комплексом QRS">
        </datalist>
      </div>
    </fieldset>

    <!-- 3. ЭОС -->
    <div class="form-group">
      <label for="eos">
        3. ЭОС 
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Выберите оценку электрической оси сердца или введите свою.
          </div>
        </span>
      </label>
      <input type="text" id="eos" name="eos" list="eosList">
      <datalist id="eosList">
        <option value="Нормальная">
        <option value="Отклонение влево">
        <option value="Отклонение вправо">
        <option value="Не определена">
      </datalist>
    </div>

    <!-- Калькулятор ЭОС -->
    <div id="eosCalcContainer">
      <h3>Калькулятор ЭОС</h3>
      <div id="eosCalcFields" class="horizontal-group">
        <div>
          <label for="otv1">Отведение 1:</label>
          <select id="otv1">
            <option value="0">aVR</option>
            <option value="1">aVL</option>
            <option value="2">aVF</option>
            <option value="3" selected>I</option>
            <option value="4">II</option>
            <option value="5">III</option>
          </select>
        </div>
        <div>
          <label for="val1">Высота R – Глубина S 1:</label>
          <input type="text" id="val1" maxlength="4" size="4">
        </div>
        <div>
          <label for="otv2">Отведение 2:</label>
          <select id="otv2">
            <option value="0">aVR</option>
            <option value="1">aVL</option>
            <option value="2">aVF</option>
            <option value="3">I</option>
            <option value="4" selected>II</option>
            <option value="5">III</option>
          </select>
        </div>
        <div>
          <label for="val2">Высота R – Глубина S 2:</label>
          <input type="text" id="val2" maxlength="4" size="4">
        </div>
      </div>
      <div id="eosCalcControl" style="display: flex; align-items: center; gap: 10px;">
        <button type="button" onclick="calcEos();" class="btn-blue">Подсчитать ЭОС</button>
        <div id="eosCalcResult">Результат: -</div>
      </div>
    </div>

    <!-- 4. Р: ширина, амплитуда, морфология -->
    <div class="form-group">
      <label>
        4. Р:
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Выберите характеристики зубца Р: ширина (например, 0,12 с), амплитуда и морфология.
          </div>
        </span>
      </label>
      <div class="horizontal-group">
        <div>
          <label for="pWidth">Ширина:</label>
          <input type="text" id="pWidth" name="pWidth" list="pWidthList">
          <datalist id="pWidthList">
            <option value="Нормальная (0,12 с)">
            <option value="Расширен (более 0,12 с)">
            <option value="Сужен (менее 0,12 с)">
          </datalist>
        </div>
        <div>
          <label for="pAmplitude">Амплитуда зубца P:</label>
          <input type="text" id="pAmplitude" name="pAmplitude" list="pAmplitudeList">
          <datalist id="pAmplitudeList">
            <option value="Нормальная амплитуда">
            <option value="Амплитуда повышена">
            <option value="Амплитуда снижена">
          </datalist>
        </div>
        <div>
          <label for="pMorphology">Морфология зубца P:</label>
          <input type="text" id="pMorphology" name="pMorphology" list="pMorphologyList">
          <datalist id="pMorphologyList">
            <option value="Нормальная морфология">
            <option value="Аномальная морфология">
          </datalist>
        </div>
      </div>
    </div>

    <!-- 5. Интервал PR -->
    <div class="form-group">
      <label for="prInterval">
        5. Интервал PR: ширина 
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Выберите состояние интервала PR или введите своё.
          </div>
        </span>
      </label>
      <input type="text" id="prInterval" name="prInterval" list="prIntervalList">
      <datalist id="prIntervalList">
        <option value="Нормальный">
        <option value="Удлиненный">
        <option value="Укороченный">
      </datalist>
    </div>

    <!-- 6. Сегмент PR -->
    <div class="form-group">
      <label for="prSegment">
        6. Сегмент PR 
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Выберите состояние сегмента PR или введите своё.
          </div>
        </span>
      </label>
      <input type="text" id="prSegment" name="prSegment" list="prSegmentList">
      <datalist id="prSegmentList">
        <option value="Изоэлектрический">
        <option value="Смещен вверх">
        <option value="Смещен вниз">
      </datalist>
    </div>

    <!-- 7. Комплекс QRS (после сегмента PR) -->
    <div class="form-group">
      <label>
        7. Комплекс QRS 
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Выберите тип комплекса QRS и его длительность.
          </div>
        </span>
      </label>
      <div class="horizontal-group">
        <div>
          <label for="qrsType">Тип комплекса:</label>
          <input type="text" id="qrsType" name="qrsType" list="qrsTypeList">
          <datalist id="qrsTypeList">
            <option value="Узкие">
            <option value="Широкие">
          </datalist>
        </div>
        <div>
          <label for="qrsDuration">Длительность (с):</label>
          <input type="text" id="qrsDuration" name="qrsDuration" list="qrsDurationList">
          <datalist id="qrsDurationList">
            <!-- Значения обновляются динамически -->
          </datalist>
        </div>
      </div>
    </div>

    <!-- 8. Сегмент ST -->
    <div class="form-group">
      <label for="stSegment">
        8. Сегмент ST 
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Выберите оценку сегмента ST или введите своё.
          </div>
        </span>
      </label>
      <input type="text" id="stSegment" name="stSegment" list="stSegmentList">
      <datalist id="stSegmentList">
        <option value="Изоэлектрический">
        <option value="Подъем">
        <option value="Депрессия">
      </datalist>
    </div>

    <!-- 9. Т: морфология, амплитуда -->
    <div class="form-group">
      <label for="tWave">
        9. Т: морфология, амплитуда 
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Выберите вариант описания Т-волны.
          </div>
        </span>
      </label>
      <input type="text" id="tWave" name="tWave" list="tWaveList">
      <datalist id="tWaveList">
        <option value="Нормальная морфология и амплитуда">
        <option value="Инвертированный Т">
        <option value="Плоский Т">
        <option value="Острый коронарный Т">
      </datalist>
    </div>

    <!-- 10. Интервал QT -->
    <div class="form-group">
      <label for="qtInterval">
        10. Интервал QT: длина 
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Выберите состояние интервала QT или введите своё. Примечание: Нормальный QTc = 340-450 с у мужчин и 340-470 с у женщин.
          </div>
        </span>
      </label>
      <input type="text" id="qtInterval" name="qtInterval" list="qtIntervalList">
      <datalist id="qtIntervalList">
        <option value="Нормальный">
        <option value="Удлиненный">
        <option value="Укороченный">
      </datalist>
    </div>

    <!-- 11. U-волна -->
    <div class="form-group">
      <label for="uWave">
        11. U-волна: морфология, амплитуда 
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Выберите оценку U-волны или введите своё.
          </div>
        </span>
      </label>
      <input type="text" id="uWave" name="uWave" list="uWaveList">
      <datalist id="uWaveList">
        <option value="Не выражена">
        <option value="Присутствует">
        <option value="Увеличенная">
      </datalist>
    </div>

    <!-- 12. Другие признаки -->
    <div class="form-group">
      <label for="otherSigns">
        12. Другие признаки 
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Введите или выберите признаки (например, дельта-волна, терминальная дисторсия QRS, J-волна и т.п.).
          </div>
        </span>
      </label>
      <input type="text" id="otherSigns" name="otherSigns">
    </div>

    <!-- 13. Заключение -->
    <div class="form-group">
      <label for="conclusion">
        13. Заключение 
        <span class="tooltip-container">?
          <div class="tooltip-content">
            Введите итоговую интерпретацию ЭКГ.
          </div>
        </span>
      </label>
      <textarea id="conclusion" name="conclusion" rows="3"></textarea>
    </div>

    <!-- Кнопки формы (порядок: Сохранить интерпретацию, Экспорт текущей записи, Очистить форму) -->
    <button type="submit" class="btn-green">Сохранить интерпретацию</button>
    <button type="button" id="exportWord" class="btn-blue">Экспорт текущей записи в Word</button>
    <button type="button" id="clearForm" class="btn-red">Очистить форму</button>
  </form>

  <!-- Блок истории -->
  <div id="history">
    <h2>История интерпретаций</h2>
    <div id="historyList"></div>
    <!-- Верхний ряд кнопок истории -->
    <div id="historyButtonsTop" style="display:flex; gap:10px; flex-wrap:wrap;">
      <button type="button" id="exportHistory" class="btn-green">Экспорт всей истории в Word</button>
      <button type="button" id="exportSelected" class="btn-green">Экспорт выделенных записей в Word</button>
      <button type="button" id="compareBtn" class="btn-blue">Сравнить выбранные</button>
    </div>
    <!-- Нижний ряд кнопок истории -->
    <div id="historyButtonsBottom" style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
      <button type="button" id="deleteSelected" class="btn-red">Удалить выбранные</button>
      <button type="button" id="clearHistory" class="btn-red">Очистить историю</button>
    </div>
  </div>

  <!-- Секция сравнения -->
  <div id="compareSection">
    <h2>Сравнение результатов</h2>
    <div id="compareContainer"></div>
    <button type="button" id="exportCompare" class="btn-green">Экспорт сравнения в Word</button>
    <button type="button" id="closeCompare" class="btn-blue">Закрыть сравнение</button>
  </div>

  <!-- Блок JSON-экспорта и импорта внизу страницы -->
  <div id="jsonButtons" style="display:flex; gap:10px; justify-content:center; margin:20px 0;">
    <button type="button" id="exportJSON" class="btn-green">Экспорт истории в JSON</button>
    <button type="button" id="importJSONBtn" class="btn-green">Импортировать и добавить истории из JSON</button>
  </div>

  <script>
    // Функция для динамического обновления списка длительности QRS в зависимости от типа
    const qrsTypeInput = document.getElementById('qrsType');
    const qrsDurationList = document.getElementById('qrsDurationList');
    function updateQrsDurationList() {
      const type = qrsTypeInput.value;
      qrsDurationList.innerHTML = '';
      let options = [];
      if(type === 'Узкие') {
        options = ['0,04 с', '0,06 с', '0,08 с', '0,10 с', '0,12 с'];
      } else if(type === 'Широкие') {
        options = ['0,14 с', '0,16 с', '0,18 с', '0,20 с', '0,30 с'];
      }
      options.forEach(opt => {
        const optionElem = document.createElement('option');
        optionElem.value = opt;
        qrsDurationList.appendChild(optionElem);
      });
    }
    qrsTypeInput.addEventListener('change', updateQrsDurationList);

    // Функция для получения даты и времени регистрации с двоеточием в формате времени
    function getFormattedDateTime() {
      const now = new Date();
      const day = ("0" + now.getDate()).slice(-2);
      const month = ("0" + (now.getMonth() + 1)).slice(-2);
      const year = now.getFullYear();
      const hours = ("0" + now.getHours()).slice(-2);
      const minutes = ("0" + now.getMinutes()).slice(-2);
      return { date: `${day}.${month}.${year}`, time: `${hours}:${minutes}` };
    }

    // Карта соответствия для экспорта (ключ: внутреннее имя, значение: заголовок)
    const exportMap = {
      fio: "ФИО пациента",
      voltage: "Оценка вольтажа",
      waves: "Наличие волн (P, f, F)",
      heartRate: "ЧСС",
      rrP: "Регулярность Р-Р",
      rrR: "Регулярность R-R",
      pQrsRelation: "Связь Р с QRS",
      eos: "ЭОС",
      pWidth: "Р (ширина)",
      pAmplitude: "Р (амплитуда)",
      pMorphology: "Р (морфология)",
      prInterval: "Интервал PR",
      prSegment: "Сегмент PR",
      qrsType: "Комплекс QRS",
      stSegment: "Сегмент ST",
      tWave: "Т-волна",
      qtInterval: "Интервал QT",
      uWave: "U-волна",
      otherSigns: "Другие признаки",
      conclusion: "Заключение"
    };

    // Экспорт текущей записи из формы в Word
    function exportToWord() {
      const data = {
        "ФИО пациента": document.getElementById('fio').value,
        "Оценка вольтажа": document.getElementById('voltage').value,
        "Наличие волн (P, f, F)": document.getElementById('waves').value,
        "ЧСС": document.getElementById('heartRate').value,
        "Регулярность Р-Р": document.getElementById('rrP').value,
        "Регулярность R-R": document.getElementById('rrR').value,
        "Связь Р с QRS": document.getElementById('pQrsRelation').value,
        "ЭОС": document.getElementById('eos').value,
        "Р (ширина)": document.getElementById('pWidth').value,
        "Р (амплитуда)": document.getElementById('pAmplitude').value,
        "Р (морфология)": document.getElementById('pMorphology').value,
        "Интервал PR": document.getElementById('prInterval').value,
        "Сегмент PR": document.getElementById('prSegment').value,
        "Комплекс QRS": document.getElementById('qrsType').value + " (" + document.getElementById('qrsDuration').value + ")",
        "Сегмент ST": document.getElementById('stSegment').value,
        "Т-волна": document.getElementById('tWave').value,
        "Интервал QT": document.getElementById('qtInterval').value,
        "U-волна": document.getElementById('uWave').value,
        "Другие признаки": document.getElementById('otherSigns').value,
        "Заключение": document.getElementById('conclusion').value
      };
      let content = `<h1 style="text-align:center;">Интерпретация ЭКГ</h1>`;
      content += `<table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse:collapse;">`;
      for (let key in data) {
        content += `<tr><td><strong>${key}</strong></td><td>${data[key]}</td></tr>`;
      }
      content += `</table>`;
      let header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
                   "xmlns:w='urn:schemas-microsoft-com:office:word' " +
                   "xmlns='http://www.w3.org/TR/REC-html40'>" +
                   "<head><meta charset='utf-8'><title>Экспорт ЭКГ</title></head><body>";
      let footer = "</body></html>";
      let sourceHTML = header + content + footer;
      const dateTime = getFormattedDateTime();
      let fileName = `ЭКГ_${document.getElementById('fio').value}_${dateTime.date}_${dateTime.time}.doc`;
      let source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
      let fileDownload = document.createElement("a");
      document.body.appendChild(fileDownload);
      fileDownload.href = source;
      fileDownload.download = fileName;
      fileDownload.click();
      document.body.removeChild(fileDownload);
    }

    // Универсальная функция экспорта записи (используется для истории и выбранных записей)
    function exportRecordContent(record) {
      let content = `<h1 style="text-align:center;">Интерпретация ЭКГ</h1>`;
      content += `<h3>${record.fio}, ${record.date} ${record.time}</h3>`;
      content += `<table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse:collapse;">`;
      for (let key in exportMap) {
        if(key in record) {
          if(key === "qrsType") {
            content += `<tr><td><strong>${exportMap[key]}</strong></td><td>${record.qrsType} (${record.qrsDuration})</td></tr>`;
          } else {
            content += `<tr><td><strong>${exportMap[key]}</strong></td><td>${record[key]}</td></tr>`;
          }
        }
      }
      content += `</table>`;
      return content;
    }

    // Экспорт всей истории в Word
    function exportHistoryToWord() {
      const historyData = JSON.parse(localStorage.getItem('ekgHistory')) || [];
      if (historyData.length === 0) {
        alert("История пуста.");
        return;
      }
      let content = `<h1 style="text-align:center;">История интерпретаций ЭКГ</h1>`;
      historyData.forEach(record => {
        content += exportRecordContent(record);
        content += `<br>`;
      });
      let header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
                   "xmlns:w='urn:schemas-microsoft-com:office:word' " +
                   "xmlns='http://www.w3.org/TR/REC-html40'>" +
                   "<head><meta charset='utf-8'><title>Экспорт Истории ЭКГ</title></head><body>";
      let footer = "</body></html>";
      let sourceHTML = header + content + footer;
      const dateTime = getFormattedDateTime();
      let fileName = `ЭКГ_История_${dateTime.date}_${dateTime.time}.doc`;
      let source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
      let fileDownload = document.createElement("a");
      document.body.appendChild(fileDownload);
      fileDownload.href = source;
      fileDownload.download = fileName;
      fileDownload.click();
      document.body.removeChild(fileDownload);
    }

    // Экспорт выделенных записей в Word
    function exportSelectedToWord() {
      const historyData = JSON.parse(localStorage.getItem('ekgHistory')) || [];
      const checkboxes = document.querySelectorAll('#historyList input[type="checkbox"]:checked');
      if (checkboxes.length === 0) {
        alert("Не выбраны записи для экспорта.");
        return;
      }
      let content = `<h1 style="text-align:center;">Выбранные интерпретации ЭКГ</h1>`;
      checkboxes.forEach(cb => {
        const index = cb.getAttribute('data-index');
        const record = historyData[index];
        content += exportRecordContent(record);
        content += `<br>`;
      });
      let header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
                   "xmlns:w='urn:schemas-microsoft-com:office:word' " +
                   "xmlns='http://www.w3.org/TR/REC-html40'>" +
                   "<head><meta charset='utf-8'><title>Экспорт Выбранных ЭКГ</title></head><body>";
      let footer = "</body></html>";
      let sourceHTML = header + content + footer;
      const dateTime = getFormattedDateTime();
      let fileName = `ЭКГ_Выбранные_${dateTime.date}_${dateTime.time}.doc`;
      let source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
      let fileDownload = document.createElement("a");
      document.body.appendChild(fileDownload);
      fileDownload.href = source;
      fileDownload.download = fileName;
      fileDownload.click();
      document.body.removeChild(fileDownload);
    }

    // Экспорт сравнения в Word (используем содержимое блока compareContainer)
    function exportComparisonToWord() {
      const compareHTML = document.getElementById('compareContainer').innerHTML;
      if(!compareHTML) {
        alert("Сначала сформируйте сравнение.");
        return;
      }
      let content = `<h1 style="text-align:center;">Сравнение интерпретаций ЭКГ</h1>`;
      content += compareHTML;
      let header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
                   "xmlns:w='urn:schemas-microsoft-com:office:word' " +
                   "xmlns='http://www.w3.org/TR/REC-html40'>" +
                   "<head><meta charset='utf-8'><title>Экспорт Сравнения ЭКГ</title></head><body>";
      let footer = "</body></html>";
      let sourceHTML = header + content + footer;
      const dateTime = getFormattedDateTime();
      let fileName = `ЭКГ_Сравнение_${dateTime.date}_${dateTime.time}.doc`;
      let source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
      let fileDownload = document.createElement("a");
      document.body.appendChild(fileDownload);
      fileDownload.href = source;
      fileDownload.download = fileName;
      fileDownload.click();
      document.body.removeChild(fileDownload);
    }

    // Экспорт истории в JSON
    function exportHistoryToJSON() {
      const historyData = JSON.parse(localStorage.getItem('ekgHistory')) || [];
      const jsonStr = JSON.stringify(historyData, null, 2);
      const blob = new Blob([jsonStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const dateTime = getFormattedDateTime();
      a.download = `ECG-interpreter-${dateTime.date}_${dateTime.time}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Импорт истории из JSON (добавление новых записей)
    function importHistoryFromJSON(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          if (Array.isArray(importedData)) {
            const currentData = JSON.parse(localStorage.getItem('ekgHistory')) || [];
            const merged = currentData.concat(importedData);
            localStorage.setItem('ekgHistory', JSON.stringify(merged));
            loadHistory();
            alert("История успешно импортирована и добавлена.");
          } else {
            alert("Неверный формат данных.");
          }
        } catch(err) {
          alert("Ошибка чтения файла JSON.");
        }
      };
      reader.readAsText(file);
    }

    // Функция для программного открытия диалога выбора файла JSON
    function triggerJSONImport() {
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = ".json";
      fileInput.onchange = function(e) {
        const file = e.target.files[0];
        if(file) {
          importHistoryFromJSON(file);
        }
      };
      fileInput.click();
    }

    // Функция для группировки истории по датам
    function loadHistory() {
      const data = JSON.parse(localStorage.getItem('ekgHistory')) || [];
      const grouped = {};
      data.forEach((record, index) => {
        if (!grouped[record.date]) {
          grouped[record.date] = [];
        }
        record._index = index;
        grouped[record.date].push(record);
      });
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      if (data.length === 0) {
        historyList.innerHTML = '<p>История пуста.</p>';
      } else {
        for (let date in grouped) {
          const details = document.createElement('details');
          details.open = true;
          const summary = document.createElement('summary');
          summary.textContent = date;
          details.appendChild(summary);
          grouped[date].forEach(record => {
            const div = document.createElement('div');
            div.className = 'record';
            div.innerHTML = `
              <div style="flex:1;">
                <input type="checkbox" data-index="${record._index}">
                <strong>${record.fio} - ${record.time}</strong>
              </div>
              <div>
                <button class="export-record-btn btn-green" data-index="${record._index}">Экспорт</button>
                <button class="delete-btn btn-red" data-index="${record._index}">Удалить</button>
              </div>
            `;
            details.appendChild(div);
          });
          historyList.appendChild(details);
        }
      }
    }

    // Функция калькулятора ЭОС (восстановлена)
    function calcEos() {
      var val1 = parseFloat(document.getElementById('val1').value);
      var val2 = parseFloat(document.getElementById('val2').value);
      var otv1 = document.getElementById('otv1').value;
      var otv2 = document.getElementById('otv2').value;
      if (isNaN(val1) || isNaN(val2) || val1 === 0 || val2 === 0) {
        alert('Введите корректные значения для Высоты R – Глубины S.');
        return;
      }
      if (otv1 === otv2) {
        alert('Выберите разные отведения.');
        return;
      }
      var coords1 = getCoords(val1, otv1);
      var coords2 = getCoords(val2, otv2);
      var res = getResultByCoords(coords1.x, coords1.y, coords2.x, coords2.y);
      if (res.error) {
        alert('Ошибка вычисления.');
        return;
      }
      var angle = Math.round(res.angle * 10) / 10;
      var resultText;
      if (angle >= 0 && angle < 90) resultText = `Нормограмма, угол α = ${angle}°`;
      else if (angle >= 90 && angle <= 180) resultText = `Правограмма, угол α = ${angle}°`;
      else if (angle < 0 && angle >= -90) resultText = `Левограмма, угол α = ${angle}°`;
      else if (angle < -90 && angle >= -180) resultText = `Не определяется, угол α = ${angle}°`;
      else resultText = `Нет данных, угол α = ${angle}°`;
      document.getElementById('eosCalcResult').innerHTML = `Результат: ${resultText}`;
      document.getElementById('eos').value = resultText;
    }
    function getCoords(val, otv) {
      var otvs = [150, 30, 270, 0, 300, 240];
      var otv_deg = (val > 0) ? otvs[otv] : (otvs[otv] + 180) % 360;
      var x = Math.abs(val) * Math.cos(otv_deg * Math.PI / 180);
      var y = Math.abs(val) * Math.sin(otv_deg * Math.PI / 180);
      return { x: x, y: y };
    }
    function getResultByCoords(x1, y1, x2, y2) {
      if ((x1 * y2 - y1 * x2) === 0) {
        return { error: 1 };
      }
      var x = (y2 * x1 * x1 + y2 * y1 * y1 - y1 * x2 * x2 - y1 * y2 * y2) / (x1 * y2 - y1 * x2);
      var y = (y1 !== 0) ? (x1 * x1 + y1 * y1 - x1 * x) / y1 : (x2 * x2 + y2 * y2 - x2 * x) / y2;
      var r = Math.sqrt(x * x + y * y);
      var angle = -Math.atan2(y, x) * 180 / Math.PI;
      return { error: null, angle: angle, len: r };
    }

    // Удаление записи с подтверждением
    function deleteRecord(index) {
      if (confirm("Вы точно хотите удалить эту запись?")) {
        const historyData = JSON.parse(localStorage.getItem('ekgHistory')) || [];
        historyData.splice(index, 1);
        localStorage.setItem('ekgHistory', JSON.stringify(historyData));
        loadHistory();
      }
    }

    // Экспорт отдельной записи по индексу
    function exportRecordToWord(index) {
      const historyData = JSON.parse(localStorage.getItem('ekgHistory')) || [];
      const record = historyData[index];
      if (!record) return;
      let content = exportRecordContent(record);
      let header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
                   "xmlns:w='urn:schemas-microsoft-com:office:word' " +
                   "xmlns='http://www.w3.org/TR/REC-html40'>" +
                   "<head><meta charset='utf-8'><title>Экспорт ЭКГ</title></head><body>";
      let footer = "</body></html>";
      let sourceHTML = header + content + footer;
      let fileName = `ЭКГ_${record.fio}_${record.date}_${record.time}.doc`;
      let source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
      let fileDownload = document.createElement("a");
      document.body.appendChild(fileDownload);
      fileDownload.href = source;
      fileDownload.download = fileName;
      fileDownload.click();
      document.body.removeChild(fileDownload);
    }

    // Обработчики для истории (без остановки всплытия)
    document.getElementById('historyList').addEventListener('click', function(e) {
      if(e.target.classList.contains('delete-btn')) {
        const idx = e.target.getAttribute('data-index');
        deleteRecord(idx);
      } else if(e.target.classList.contains('export-record-btn')) {
        const idx = e.target.getAttribute('data-index');
        exportRecordToWord(idx);
      }
    });

    // Обработчики экспорта и импорта JSON (кнопки внизу)
    document.getElementById('exportJSON').addEventListener('click', exportHistoryToJSON);
    document.getElementById('importJSONBtn').addEventListener('click', triggerJSONImport);

    // Обработчики для экспорта истории и выбранных записей в Word, а также сравнения
    document.getElementById('exportHistory').addEventListener('click', exportHistoryToWord);
    document.getElementById('exportSelected').addEventListener('click', exportSelectedToWord);
    document.getElementById('exportWord').addEventListener('click', exportToWord);
    document.getElementById('exportCompare').addEventListener('click', exportComparisonToWord);

    // Обработчик для сравнения выбранных записей
    document.getElementById('compareBtn').addEventListener('click', function() {
      const checkboxes = document.querySelectorAll('#historyList input[type="checkbox"]:checked');
      if(checkboxes.length < 2) {
        alert('Выберите минимум две записи для сравнения.');
        return;
      }
      const historyData = JSON.parse(localStorage.getItem('ekgHistory')) || [];
      const selectedRecords = [];
      checkboxes.forEach(cb => {
        const index = cb.getAttribute('data-index');
        selectedRecords.push(historyData[index]);
      });
      let table = `<table class="compare-table">`;
      table += `<tr><th>Параметр</th>`;
      selectedRecords.forEach(record => {
        table += `<th>${record.fio}<br>${record.date} ${record.time}</th>`;
      });
      table += `</tr>`;
      for (let key in exportMap) {
        table += `<tr><td><strong>${exportMap[key]}</strong></td>`;
        selectedRecords.forEach(record => {
          let value = "";
          if(key === "qrsType") {
            value = record.qrsType + " (" + record.qrsDuration + ")";
          } else {
            value = record[key] || "";
          }
          table += `<td>${value}</td>`;
        });
        table += `</tr>`;
      }
      table += `</table>`;
      document.getElementById('compareContainer').innerHTML = table;
      document.getElementById('compareSection').style.display = 'block';
      document.getElementById('compareSection').scrollIntoView({ behavior: 'smooth' });
    });

    // Обработчик для закрытия сравнения
    document.getElementById('closeCompare').addEventListener('click', function() {
      document.getElementById('compareSection').style.display = 'none';
    });

    // Обработчик для удаления выбранных записей
    document.getElementById('deleteSelected').addEventListener('click', function() {
      const checkboxes = document.querySelectorAll('#historyList input[type="checkbox"]:checked');
      if (checkboxes.length === 0) {
        alert("Не выбраны записи для удаления.");
        return;
      }
      if(!confirm("Вы точно хотите удалить выбранные записи?")) return;
      const historyData = JSON.parse(localStorage.getItem('ekgHistory')) || [];
      const indices = Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-index')));
      indices.sort((a, b) => b - a);
      indices.forEach(idx => {
        historyData.splice(idx, 1);
      });
      localStorage.setItem('ekgHistory', JSON.stringify(historyData));
      loadHistory();
    });

    // Обработчик для очистки истории
    document.getElementById('clearHistory').addEventListener('click', function() {
      if(confirm("Вы точно хотите очистить всю историю?")) {
        localStorage.removeItem('ekgHistory');
        loadHistory();
      }
    });

    // Обработчик для очистки формы
    document.getElementById('clearForm').addEventListener('click', function() {
      document.getElementById('ekgForm').reset();
    });

    // Обработчик для сохранения формы (форма НЕ очищается)
    document.getElementById('ekgForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const dateTime = getFormattedDateTime();
      const formData = {
        fio: document.getElementById('fio').value,
        voltage: document.getElementById('voltage').value,
        waves: document.getElementById('waves').value,
        heartRate: document.getElementById('heartRate').value,
        rrP: document.getElementById('rrP').value,
        rrR: document.getElementById('rrR').value,
        pQrsRelation: document.getElementById('pQrsRelation').value,
        eos: document.getElementById('eos').value,
        pWidth: document.getElementById('pWidth').value,
        pAmplitude: document.getElementById('pAmplitude').value,
        pMorphology: document.getElementById('pMorphology').value,
        prInterval: document.getElementById('prInterval').value,
        prSegment: document.getElementById('prSegment').value,
        qrsType: document.getElementById('qrsType').value,
        qrsDuration: document.getElementById('qrsDuration').value,
        stSegment: document.getElementById('stSegment').value,
        tWave: document.getElementById('tWave').value,
        qtInterval: document.getElementById('qtInterval').value,
        uWave: document.getElementById('uWave').value,
        otherSigns: document.getElementById('otherSigns').value,
        conclusion: document.getElementById('conclusion').value,
        date: dateTime.date,
        time: dateTime.time
      };
      const historyData = JSON.parse(localStorage.getItem('ekgHistory')) || [];
      historyData.push(formData);
      localStorage.setItem('ekgHistory', JSON.stringify(historyData));
      loadHistory();
    });

    window.onload = loadHistory;
  </script>
</body>
</html>
